name: DevInsight AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run-devinsight-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        continue-on-error: true

      - name: Get PR diff
        id: diff
        continue-on-error: true
        run: |
          echo "Collecting changed files..."
          git fetch origin ${{ github.event.pull_request.base.ref }} || true
          git diff FETCH_HEAD > diff.txt || echo "No diff found" > diff.txt

      - name: Build JSON payload
        id: payload
        continue-on-error: true
        run: |
          DIFF_CONTENT=$(sed 's/"/\\"/g' diff.txt)
          echo "{
            \"pr_title\": \"${{ github.event.pull_request.title }}\",
            \"pr_number\": ${{ github.event.pull_request.number }},
            \"repo_name\": \"${{ github.repository }}\",
            \"diffs\": [
              {
                \"filename\": \"diff.patch\",
                \"old_code\": \"\",
                \"new_code\": \"${DIFF_CONTENT}\"
              }
            ]
          }" > payload.json

      - name: Call DevInsight Backend
        id: call_backend
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            https://nongrievous-kazuko-unrelatively.ngrok-free.dev/review || echo "")
          echo "$RESPONSE" > review_response.json

      - name: Post Review Comment to PR
        continue-on-error: true
        run: |
          # Case 1: Backend returned review comments
          if jq -e '.comments | length > 0' review_response.json > /dev/null 2>&1; then
            COMMENTS=$(jq -r '.comments[] | "- **File:** \(.filename)  \n  **Line:** \(.line)  \n  **Severity:** \(.severity)  \n  **Message:** \(.message)"' review_response.json)
            BODY="### ğŸ¤– DevInsight AI Code Review\n$COMMENTS"

          # Case 2: Backend reachable but no issues found
          elif jq -e '.comments' review_response.json > /dev/null 2>&1; then
            BODY="### ğŸ¤– DevInsight AI Code Review\nâœ” No issues found â€” great work!"

          # Case 3: Backend unreachable / invalid response
          else
            BODY="### ğŸ¤– DevInsight AI Code Review\nâš ï¸ Backend unreachable â€” no review generated."
          fi

          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -f body="$BODY"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
